<!doctype html>
<html>
  <head>
    <title>1minLCS</title>
    <meta charset="utf-8">
    <link  href="" rel="stylesheet"/>
  </head>
<body oncontextmenu="return false;" style="  margin: 0px; overflow: hidden;background-color: black; background-image: url('img/background.png'); background-repeat: no-repeat">
    
<div id="container"></div>

<script src="http://mrdoob.github.com/three.js/build/three.min.js"></script>
<script src="js/cloth.js"></script>

<script src="js/mirror.js"></script>
<script src="js/watershader.js"></script>

<script type="text/javascript">


    var renderer, scene, camera, projector, mesh, objects = [], theta=0, phi=0, radius = 300, spriteList = [], foretList = [], materials = [], lightList = [], flags = [], frameClock = new THREE.Clock();
    var particleCount = 100;
    var particleSystem;
    var champ1;
    var lookAtVector = new THREE.Vector3(0,0,0);

    var mouseDown = false;
    var lastMousePosition = {x:0, y:0}
    var rightMouseDown = false;

    var offset = {x: 0.5,y: 0.5, z: 0}
    var particles
    var parameters = {
        width: 1,
        height: 1,
        widthSegments: 250,
        heightSegments: 250,
        depth: 1500,
        param: 4,
        filterparam: 1
    }
    
    var waterNormals;


    var pins = [ 0,1,2,3,4,5,6,7,8,9, 10,11,12,13,14,15,16,17,18,19, 20,21,22,23,24,25,26,27,28,29, 30 ]; // classic 2 pins


    var container, stats;

    var clothGeometry;
    var object, arrow;


    function Border( x, y, z, textures, rotation, height ) {
        this.parent = new THREE.Object3D();

        var textureWood = THREE.ImageUtils.loadTexture( textures.plank );
        var materialBord = new THREE.MeshPhongMaterial( { map: textureWood} );
        var geometryBord = new THREE.CubeGeometry(215 , 4, height );
        this.bord = new THREE.Mesh( geometryBord, materialBord );
        this.bord.position.set(x, y, z);
        this.bord.rotation.z = rotation;

        this.parent.add(this.bord)

        var functionPlank = function(pos) {
            if (pos.z > 0.1 && pos.y > 41) {
                pos.z = 0.1
                console.log()
            }
            return pos.z
        }
        var flag = new Flag(3, 30, 10, x, y, z - 59.9 + height / 2, textures.flag, textures.top, functionPlank)
        flags.push(flag)
        flag.rotate(rotation + Math.PI / 2)
        this.flag = flag;
        this.parent.add(flag.parent)
    }


    function Minimap(heightmap, textures, buildingsPositions, treePositions, lightsPositions ) {



        // attributes :
        this.parent = new THREE.Object3D();
        this.parentGround = new THREE.Object3D();
        this.ready = false;
        this.mapReady = false;
        this.bordure;                  //
        this.bordure2;                 // => borders
        this.bordure3;                 //
        this.bordure4;                 //
        this.material;              // ground texture
        this.mesh;                  // ground mesh
        this.buildings;             // buildings
        this.spriteList = [];
        this.flags = [];

        var heightHere = 0




        // LOGOS MINIMAP
        var logo1 = new THREE.PlaneGeometry( 20, 20 );
        var logo2 = new THREE.PlaneGeometry( 20, 20 );
        var groundTexture = THREE.ImageUtils.loadTexture( textures.groundTexture )

        groundTexture.magFilter = THREE.NearestFilter
        groundTexture.minFilter = THREE.NearestFilter

        this.material = new THREE.MeshLambertMaterial( { map: groundTexture, overdraw: true,  side: THREE.DoubleSide } );
        materials.push(this.material)
        var texturelogo1 = new THREE.MeshLambertMaterial( { map: THREE.ImageUtils.loadTexture( textures.logo1 ),transparent: true, opacity : 0.8} );
        var texturelogo2 = new THREE.MeshLambertMaterial( { map: THREE.ImageUtils.loadTexture( textures.logo2 ),transparent: true, opacity : 0.8} );


        var map = new THREE.PlaneGeometry( 200, 200, 20, 20 );
        map.vertices = heightmap;
        this.mesh = new THREE.Mesh( map, this.material );
        objects.push(this.mesh);
        this.map = map;

        var meshLogo1 = new THREE.Mesh( logo1, texturelogo1 );
        meshLogo1.position.set(60, 66, 2.1);
        meshLogo1.rotation.z = -0.8;
        var meshLogo2 = new THREE.Mesh( logo2, texturelogo2 );
        meshLogo2.position.set(-62, -62, 2.1);
        meshLogo2.rotation.z = 2.42;

        this.parentGround.add( this.mesh );
        this.parentGround.add( meshLogo1 );
        this.parentGround.add( meshLogo2 );

        // LIGHTS MINIMAP

        var directionalLight = new THREE.DirectionalLight( 0xff9955, 1 );
        directionalLight.position.set( - 1, 0.4, - 1 );

        var lights = []
        for (var i = 0; i < lightsPositions.length; ++i) {

            heightHere =  getNearestVertice(lightsPositions[i].x, lightsPositions[i].y, this.mesh)
            lights.push(new THREE.PointLight( 0xFF7722, 3, 15 ));
            lights[i].position.set(  lightsPositions[i].x,  lightsPositions[i].y,  lightsPositions[i].z );
            this.parent.add(lights[i])

        }
        this.parent.add( directionalLight );


        function getNearestVertice(x, y) {
                for (var i = 0, l = map.vertices.length; i < l; i++) {
                    if (map.vertices[i].x + 5 < x +8 && map.vertices[i].x + 5> x -8 &&
                        map.vertices[i].y+ 2 < y +8 && map.vertices[i].y+ 2 > y -8) {
                        return map.vertices[i].z + 5;
                }
            }
            return 5;
        }

        // CADRE MINIMAP
       
        this.bordure  = new Border( 100, 0, 0,  {"plank" : textures.plank, "flag" : textures.flagRed, "top" : textures.topRed}, 3 * Math.PI / 2 , 15) 
        this.bordure2 = new Border( 0, 100, 0,  {"plank" : textures.plank, "flag" : textures.flagRed, "top" : textures.topRed}, 0 ,10 ) 
        this.bordure3 = new Border( -100, 0, 0, {"plank" : textures.plank, "flag" : textures.flagBlue, "top" : textures.topBlue}, Math.PI / 2 , 15) 
        this.bordure4 = new Border( 0, -100, 0, {"plank" : textures.plank, "flag" : textures.flagBlue, "top" : textures.topBlue}, Math.PI , 10) 
        this.parent.add( this.bordure.parent );
        this.parent.add( this.bordure2.parent );
        this.parent.add( this.bordure3.parent );
        this.parent.add( this.bordure4.parent );

        this.flags.push(this.bordure.flag)
        this.flags.push(this.bordure2.flag)
        this.flags.push(this.bordure3.flag)
        this.flags.push(this.bordure4.flag)



        // WATER MINIMAP

        var waterNormals = new THREE.ImageUtils.loadTexture( 'img/waternormals.jpg' );
        waterNormals.wrapS = waterNormals.wrapT = THREE.RepeatWrapping; 

        this.water = new THREE.Water( renderer, camera, scene, {
            textureWidth: 512, 
            textureHeight: 512,
            waterNormals: waterNormals,
            alpha:  0.5,
            sunDirection: directionalLight.position.normalize(),
            sunColor: 0xff5500,
            waterColor: 0x001e0f,
            distortionScale: 10.0,
        } );


        this.mirrorMesh = new THREE.Mesh(
            new THREE.PlaneGeometry( parameters.width * 200, parameters.height * 30, 50, 50 ), 
            this.water.material
        );
        
        this.mirrorMesh.position.z = -6
        this.mirrorMesh.add( this.water );
        this.mirrorMesh.rotation.z = - Math.PI * 0.25;

        this.parentGround.add( this.mirrorMesh );

        this.parent.add( this.parentGround );

        // BUILDINGS MINIMAP

        for (var i = 0; i < buildingsPositions.redTowers.length; ++i) {

            heightHere =  getNearestVertice(buildingsPositions.redTowers[i].x, buildingsPositions.redTowers[i].y)
            this.spriteList.push(new SpriteBatiment(buildingsPositions.redTowers[i].x, buildingsPositions.redTowers[i].y, heightHere + 0, 6, 10, textures.redTower, 0xff0088))
        }
        for (var i = 0; i < buildingsPositions.blueTowers.length; ++i) {
            heightHere =  getNearestVertice(buildingsPositions.blueTowers[i].x, buildingsPositions.blueTowers[i].y)
            this.spriteList.push(new SpriteBatiment(buildingsPositions.blueTowers[i].x, buildingsPositions.blueTowers[i].y, heightHere + 0, 6, 10, textures.blueTower, 0x0088ff))
        }


        this.spriteList.push(new Sprite(-75, -50, getNearestVertice(-75, -50)-4, 6, 4, textures.blueInhib))
        this.spriteList.push(new Sprite(-51, -51, getNearestVertice(-51, -51)-4, 6, 4, textures.blueInhib))
        this.spriteList.push(new Sprite(-45, -78, getNearestVertice(-45, -78)-4, 6, 4, textures.blueInhib))

        this.spriteList.push(new Sprite(48, 53, getNearestVertice(48, 53)-4, 6, 4, textures.redInhib))
        this.spriteList.push(new Sprite(70, 50, getNearestVertice(70, 50)-4, 6, 4, textures.redInhib))
        this.spriteList.push(new Sprite(45, 78, getNearestVertice(45, 78)-4, 6, 4, textures.redInhib))

        this.spriteList.push(new Sprite(-67, -72, getNearestVertice(-67, -72)-2, 8, 7, textures.blueNexus))
        this.spriteList.push(new Sprite(69, 73, getNearestVertice(69, 73)-2, 8, 7,  textures.redNexus))


        // JUNGLE MINIMAP

        for (var j = 0; j < treePositions.length; ++j) {
            heightHere =  getNearestVertice(treePositions[j].x, treePositions[j].y)
            this.spriteList.push(new Sprite(treePositions[j].x, treePositions[j].y, heightHere, Math.random() * 3 + 2, Math.random()* 4 + 5, textures.tree))
        }




        for (var i = this.spriteList.length - 1; i >= 0; i--) {
            this.parent.add(this.spriteList[i].mesh);
            this.parent.add(this.spriteList[i].light);
        };

    }

    Minimap.prototype.create = function() {
        this.parentGround.position.z = -500
        this.bordure.parent.position.x = 500
        this.bordure2.parent.position.y = 500
        this.bordure3.parent.position.x = -500
        this.bordure4.parent.position.y = -500

        for (var i = this.spriteList.length - 1; i >= 0; i--) {
            this.spriteList[i].mesh.scale.y = 0
            this.spriteList[i].mesh.position.z -= 3
        };
    }


    Minimap.prototype.simulate = function(time, elapsedTime) {
        if (!this.ready) {
                if (!this.mapReady) {
                    this.parentGround.position.z += 2000 * elapsedTime
                    this.bordure.parent.position.x -= 2000 * elapsedTime
                    this.bordure2.parent.position.y -= 2000 * elapsedTime
                    this.bordure3.parent.position.x += 2000 * elapsedTime
                    this.bordure4.parent.position.y += 2000 * elapsedTime

                    if (this.bordure.parent.position.x < 0 ) {
                        this.parentGround.position.z = 0
                        this.bordure.parent.position.x =  0
                        this.bordure2.parent.position.y = 0
                        this.bordure3.parent.position.x = 0
                        this.bordure4.parent.position.y = 0
                        this.mapReady = true;
                    } 
                } else {
                    for (var i = this.spriteList.length - 1; i >= 0; i--) {
                        this.spriteList[i].grow(elapsedTime);
                    };
                    if (this.spriteList[0].mesh.scale.y > this.spriteList[0].height) {
                        this.spriteList[0].mesh.scale.y = this.spriteList[0].height;
                        this.ready = true;
                    }
                }

        }
        for (var j = this.flags.length - 1; j >= 0; j--) {
            if (typeof this.flags[j] != 'undefined') {

                windStrength = Math.cos( time / 7000 ) *2;
                windForce.set( Math.sin( time / 2000 + this.flags[j].random  ), Math.cos( time / 3000 + this.flags[j].random  ), Math.sin( time / 1000 + this.flags[j].random ) ).normalize().multiplyScalar( windStrength );


                this.flags[j].simulate(time);

                var timer = Date.now() * 0.0002;

                var p = this.flags[j].cloth.particles;
                // console.log(p)

                for ( var i = 0, il = p.length; i < il; i ++ ) {
                    this.flags[j].clothGeometry.vertices[i].copy(p[ i ].position);

                }

                this.flags[j].clothGeometry.computeFaceNormals();
                this.flags[j].clothGeometry.computeVertexNormals();

                this.flags[j].clothGeometry.normalsNeedUpdate = true;
                this.flags[j].clothGeometry.verticesNeedUpdate = true;
            }

        };


        this.water.material.uniforms.time.value += 1.0 / 60.0;
        this.water.render()
    }

    ////////////////////////// classe Sprite
    function Sprite(x, y, z, w, h, img){
        // objects.push( this.mesh );


        // var textureCanvas2 = new THREE.Texture( imageCanvas, THREE.UVMapping, THREE.RepeatWrapping, THREE.RepeatWrapping, THREE.NearestFilter, THREE.NearestFilter );
        // Texture( image, mapping, wrapS, wrapT, magFilter, minFilter, format, type, anisotropy )
        var texture = THREE.ImageUtils.loadTexture( img )
        texture.magFilter = THREE.NearestFilter
        texture.minFilter = THREE.NearestFilter

        var material = new THREE.SpriteMaterial( { map: texture, color: 0xffffff, fog: true } );
        materials.push(material)
        this.mesh = new THREE.Sprite( material );
        this.mesh.scale.set( w, h, 1 );
        this.mesh.position.set(x, y, z)
        this.height = h

    }
    Sprite.prototype.update = function() {
    }

    Sprite.prototype.grow = function(elapsedTime) {
        if (this.mesh.scale.y < this.height ) {
            this.mesh.scale.y += elapsedTime *  10;
            this.mesh.position.z += elapsedTime * 2
        }
    }


    ////////////////////////// classe SpriteBatiment
    function SpriteBatiment(x, y, z, w, h, img, couleur){
        this.light = new THREE.PointLight( couleur, 3, 18 );
        this.light.position.set(x, y, z + 3)
        // objects.push( this.mesh );


        var texture = THREE.ImageUtils.loadTexture( img )
        texture.magFilter = THREE.NearestFilter
        texture.minFilter = THREE.NearestFilter

        var material = new THREE.SpriteMaterial( { map: texture , color: 0xffffff, fog: true } );
        materials.push(material)
        this.mesh = new THREE.Sprite( material );
        this.mesh.scale.set( w, h, 1 );
        this.mesh.position.set(x, y, z)
        //texture
    }



    SpriteBatiment.prototype = new Sprite()





  ////////////////////////// classe flag
    function Flag(restDistance, xSegs, ySegs, x, y, z, img, imgTop, plank){
        this.parent = new THREE.Object3D();
        this.cloth = new Cloth(xSegs, ySegs, plank, plane(restDistance  * xSegs, restDistance * 4 * ySegs), restDistance) 
        this.random =  Math.random() * 700647948;
        var clothTexture = THREE.ImageUtils.loadTexture( img );
        var clothTop = THREE.ImageUtils.loadTexture( imgTop );

        clothTexture.magFilter = THREE.NearestFilter
        clothTexture.minFilter = THREE.NearestFilter
        clothTexture.wrapS = clothTexture.wrapT = THREE.RepeatWrapping;
        clothTexture.anisotropy = 16;

        var geometrytop = new THREE.PlaneGeometry( 90, 4.45 );
        var geometrybehind = new THREE.PlaneGeometry( 90, 15 );
        var materialtop = new THREE.MeshPhongMaterial(({ map : clothTop, side: THREE.DoubleSide}) );
        this.top = new THREE.Mesh( geometrytop, materialtop );
        this.behind = new THREE.Mesh( geometrybehind, materialtop );
        this.top.rotation.z = Math.PI/2 
        this.parent.position.set( x, y, z+60 );

        this.top.position.set( 0, 0, 0 );
        this.behind.position.set( -2.2, 0, -7.5 );
        this.behind.rotation.z = Math.PI/2;
        this.behind.rotation.y = Math.PI/2;

        var clothMaterial = new THREE.MeshPhongMaterial( { alphaTest: 0.5, ambient: 0xffffff, color: 0xffffff, specular: 0x030303, emissive: 0x111111, shininess: 10, map: clothTexture, side: THREE.DoubleSide } );

        // cloth geometry
        this.clothGeometry = new THREE.ParametricGeometry( this.cloth.clothFunction, this.cloth.w, this.cloth.h );
        // console.log(clothGeometry.vertices)
        this.clothGeometry.dynamic = true;
        this.clothGeometry.computeFaceNormals();

        this.object = new THREE.Mesh( this.clothGeometry, clothMaterial );
        this.object.position.set( 2.15, 0.1, -60 );
        this.object.rotation.y = 3 * Math.PI/2
        this.object.rotation.x = Math.PI/2 
        this.parent.add(this.object)
        this.parent.add(this.top)
        this.parent.add(this.behind)
        // scene.add(this.parent)
        //texture
    }


    Flag.prototype.simulate = function(time) {
        simulate(time, this)
    }


    Flag.prototype.rotate = function(angle) {
        this.parent.rotation.z += angle 
    }





    ////////////////////////// classe SpriteAnimated
    function SpriteAnimated(x, y, z, w, h, img, couleur){
        var selfTexture = new THREE.ImageUtils.loadTexture(img);

        selfTexture.magFilter = THREE.NearestFilter
        selfTexture.minFilter = THREE.NearestFilter
        this.sprite1 = [new THREE.Vector2(0, 0), new THREE.Vector2(.333, 0), new THREE.Vector2(.333, 1), new THREE.Vector2(0, 1)];
        this.sprite2 = [new THREE.Vector2(0.333, 0), new THREE.Vector2(.666, 0), new THREE.Vector2(.666, 1), new THREE.Vector2(0.333, 1)];
        this.sprite3 = [new THREE.Vector2(0.666, 0), new THREE.Vector2(1, 0), new THREE.Vector2(1, 1), new THREE.Vector2(0.666, 1)];
        this.frame = Math.random() * 20;
        var material = new THREE.MeshLambertMaterial( { map: selfTexture,transparent: true,  overdraw: true, alphaTest: 0.5 } );
        materials.push(material);
        var geometry = new THREE.PlaneGeometry( w, h);
        geometry.faceVertexUvs[0][0] = [ this.sprite3[0], this.sprite3[1], this.sprite3[3] ];
        geometry.faceVertexUvs[0][1] = [ this.sprite3[1], this.sprite3[2], this.sprite3[3] ];
        this.mesh = new THREE.Mesh(geometry, material);
        this.light = new THREE.PointLight( couleur, 5, 19 );
        this.light.position.set(x, y, z - 3);
        this.mesh.position.set(x, y, z);
        this.mesh.rotation.x = Math.PI/2;
        this.mesh.rotation.y = Math.PI/2;
    }
    //heritage
    SpriteAnimated.prototype = new Sprite()
    SpriteAnimated.prototype.update = function(theta) {
        this.mesh.rotation.y = theta + Math.PI/2;
        this.mesh.rotation.z = camera.rotation.z;
        this.mesh.rotation.y = camera.rotation.y;
        this.mesh.rotation.x = camera.rotation.x;
        var oldframe = this.frame;

        var tabFrame = [this.sprite1,this.sprite1, this.sprite2, this.sprite3,this.sprite3, this.sprite2];
        this.frame += 1;
        if (this.frame > 50)  this.frame = 0;
        if (tabFrame[Math.round(oldframe/10)] != tabFrame[Math.round(this.frame/10)]) {
         this.mesh.geometry.faceVertexUvs[0][0] = [ tabFrame[Math.round(this.frame/10)][0],  tabFrame[Math.round(this.frame/10)][1],  tabFrame[Math.round(this.frame/10)][3] ];
         this.mesh.geometry.faceVertexUvs[0][1] = [ tabFrame[Math.round(this.frame/10)][1],  tabFrame[Math.round(this.frame/10)][2],  tabFrame[Math.round(this.frame/10)][3] ];
         this.mesh.geometry.uvsNeedUpdate= true;
        }
    }





    // ////////////////////////// classe SpriteAnimated
    // function SpriteAnimated(x, y, z, w, h, texture, couleur){
    //     var selfTexture = new THREE.ImageUtils.loadTexture(texture);
    //     this.frame1 = [new THREE.Vector2(0, 0), new THREE.Vector2(.333, 0), new THREE.Vector2(.333, 1), new THREE.Vector2(0, 1)];
    //     this.frame2 = [new THREE.Vector2(0.333, 0), new THREE.Vector2(.666, 0), new THREE.Vector2(.666, 1), new THREE.Vector2(0.333, 1)];
    //     this.frame3 = [new THREE.Vector2(0.666, 0), new THREE.Vector2(1, 0), new THREE.Vector2(1, 1), new THREE.Vector2(0.666, 1)];
    //     this.frame = Math.random() * 20;
    //     var material = new THREE.SpriteMaterial( { map: selfTexture,transparent: true,  overdraw: true, alphaTest: 0.5 } );
    //     materials.push(material);
    //     var sprite = new THREE.Sprite( material );
    //     sprite.scale.set( w, h, 1 );
    //     console.log(sprite.geometry)
    //     // sprite.geometry.faceVertexUvs = [ this.frame3[0], this.frame3[1], this.frame3[3] ];
    //     this.mesh = sprite
    //     console.log(this.mesh.geometry)
    //     this.light = new THREE.PointLight( couleur, 5, 19 );
    //     this.light.position.set(x, y, z - 3);
    //     this.mesh.position.set(x, y, z);
    // }
    // //heritage
    // SpriteAnimated.prototype = new Sprite()
    // SpriteAnimated.prototype.update = function(theta) {

    //     // this.mesh.rotation.y = theta + Math.PI/2;
    //     // this.mesh.rotation.x = theta;
    //     var oldframe = this.frame;

    //     var tabFrame = [this.frame1,this.frame1, this.frame2, this.frame3,this.frame3, this.frame2];
    //     this.frame += 1;
    //     if (this.frame > 50)  this.frame = 0;
    //     if (tabFrame[Math.round(oldframe/10)] != tabFrame[Math.round(this.frame/10)]) {
    //         // this.mesh.geometry.faceVertexUvs = [ tabFrame[Math.round(this.frame/10)][0],  tabFrame[Math.round(this.frame/10)][1],  tabFrame[Math.round(this.frame/10)][3] ];
    //         // this.mesh.geometry.uvsNeedUpdate= true;
    //     }
    // }

    ////////////////////////// classe SpriteAnimated
    function SpriteHero(x, y, z, w, h, texture, couleur, buff){
        //sprite
        var material = new THREE.SpriteMaterial( { map: THREE.ImageUtils.loadTexture( texture ), color: 0xffffff, fog: true } );
        materials.push(material);
        this.mesh = new THREE.Sprite( material );
        this.mesh.scale.set( w, h, 1 );
        this.mesh.position.set(x, y, z);


        //cross

        var cross = new THREE.PlaneGeometry( 6, 6 );
        var crossTexture = new THREE.MeshLambertMaterial( { map: THREE.ImageUtils.loadTexture('img/cross.png' ),transparent: true, opacity : 0.8} );
        this.meshCross = new THREE.Mesh( cross, crossTexture );
        this.meshCross.position.set(x, y, 1)
        scene.add(this.meshCross)

        //lumiere
        this.light = new THREE.PointLight( couleur, 5, 19 );
        this.light.position.set(x, y, z - 3);
        this.mesh.position.set(x, y, z);
        this.mesh.rotation.x = Math.PI/2;
        this.mesh.rotation.y = Math.PI/2;


        //buff []
        this.buff = []
        for (var i = 0; i < buff.length; i++) {
            var particles = new THREE.Geometry()
            var pMaterial = new THREE.ParticleBasicMaterial({
                color: 0xFFFFFF,
                size: 2,
                map: THREE.ImageUtils.loadTexture(buff[i]),
                blending: THREE.AdditiveBlending,
                transparent: true
            });

            for (var p = 0; p < 3; p++) {
                var pX = Math.random() * 500 - 250,
                    pY = Math.random() * 500 - 250,
                    pZ = Math.random() * 500 - 250
                var particle = new THREE.Vector3(pX, pY, pZ);
                    particle.velocity = new THREE.Vector3(pX/2, pY/2, pZ/2);
                // add it to the geometry
                particles.vertices.push(particle);
            }
            // create the particle system
            this.buff.push(new THREE.ParticleSystem(
                particles,
                pMaterial
            ));
        }


    }
    //heritage
    SpriteHero.prototype = new Sprite()
    SpriteHero.prototype.move = function(offset) {
        this.mesh.position.x += offset.x;
        this.mesh.position.y += offset.y;
        this.mesh.position.z += offset.z;

        this.meshCross.position.x += offset.x;
        this.meshCross.position.y += offset.y;
        this.meshCross.position.z = getHeight( this.meshCross.position.x, this.meshCross.position.y) - 4.5;
    }



    init();
    animate();

    function init(){
        var arrayMap =[{"x":-100,"y":100,"z":1},{"x":-90,"y":100,"z":2.5},{"x":-80,"y":100,"z":2.5},{"x":-70,"y":100,"z":1.5},{"x":-60,"y":100,"z":1},{"x":-50,"y":100,"z":1.5},{"x":-40,"y":100,"z":1.5},{"x":-30,"y":100,"z":2.5},{"x":-20,"y":100,"z":3},{"x":-10,"y":100,"z":2.5},{"x":0,"y":100,"z":2.5},{"x":10,"y":100,"z":2.5},{"x":20,"y":100,"z":2},{"x":30,"y":100,"z":1.5},{"x":40,"y":100,"z":2.5},{"x":50,"y":100,"z":2.5},{"x":60,"y":100,"z":1.5},{"x":70,"y":100,"z":0.5},{"x":80,"y":100,"z":0},{"x":90,"y":100,"z":0},{"x":100,"y":100,"z":0},{"x":-100,"y":90,"z":2},{"x":-90,"y":90,"z":5},{"x":-80,"y":90,"z":5.5},{"x":-70,"y":90,"z":4},{"x":-60,"y":90,"z":2},{"x":-50,"y":90,"z":1.5},{"x":-40,"y":90,"z":1.5},{"x":-30,"y":90,"z":2.5},{"x":-20,"y":90,"z":3},{"x":-10,"y":90,"z":2.5},{"x":0,"y":90,"z":2.5},{"x":10,"y":90,"z":1},{"x":20,"y":90,"z":0.5},{"x":30,"y":90,"z":2},{"x":40,"y":90,"z":2},{"x":50,"y":90,"z":2},{"x":60,"y":90,"z":2},{"x":70,"y":90,"z":2},{"x":80,"y":90,"z":2},{"x":90,"y":90,"z":0},{"x":100,"y":90,"z":0},{"x":-100,"y":80,"z":1.5},{"x":-90,"y":80,"z":4.5},{"x":-80,"y":80,"z":4.5},{"x":-70,"y":80,"z":2},{"x":-60,"y":80,"z":0.5},{"x":-50,"y":80,"z":-1},{"x":-40,"y":80,"z":-1},{"x":-30,"y":80,"z":-1},{"x":-20,"y":80,"z":-1.5},{"x":-10,"y":80,"z":-1},{"x":0,"y":80,"z":-1},{"x":10,"y":80,"z":-2.5},{"x":20,"y":80,"z":-2.5},{"x":30,"y":80,"z":2},{"x":40,"y":80,"z":2},{"x":50,"y":80,"z":2},{"x":60,"y":80,"z":2},{"x":70,"y":80,"z":2},{"x":80,"y":80,"z":2},{"x":90,"y":80,"z":3},{"x":100,"y":80,"z":1.5},{"x":-100,"y":70,"z":2.5},{"x":-90,"y":70,"z":4.5},{"x":-80,"y":70,"z":1},{"x":-70,"y":70,"z":-2.5},{"x":-60,"y":70,"z":-1.5},{"x":-50,"y":70,"z":-1},{"x":-40,"y":70,"z":-1},{"x":-30,"y":70,"z":-1.5},{"x":-20,"y":70,"z":-2.5},{"x":-10,"y":70,"z":-2},{"x":0,"y":70,"z":-1.5},{"x":10,"y":70,"z":-2},{"x":20,"y":70,"z":-2.5},{"x":30,"y":70,"z":2},{"x":40,"y":70,"z":2},{"x":50,"y":70,"z":2},{"x":60,"y":70,"z":2},{"x":70,"y":70,"z":2},{"x":80,"y":70,"z":2},{"x":90,"y":70,"z":6},{"x":100,"y":70,"z":2},{"x":-100,"y":60,"z":3},{"x":-90,"y":60,"z":4},{"x":-80,"y":60,"z":-1.5},{"x":-70,"y":60,"z":-4},{"x":-60,"y":60,"z":-3},{"x":-50,"y":60,"z":-1.5},{"x":-40,"y":60,"z":-0.5},{"x":-30,"y":60,"z":-1},{"x":-20,"y":60,"z":-1},{"x":-10,"y":60,"z":-2.5},{"x":0,"y":60,"z":-2},{"x":10,"y":60,"z":-1.5},{"x":20,"y":60,"z":-3},{"x":30,"y":60,"z":2},{"x":40,"y":60,"z":2},{"x":50,"y":60,"z":2},{"x":60,"y":60,"z":2},{"x":70,"y":60,"z":2},{"x":80,"y":60,"z":2},{"x":90,"y":60,"z":5.5},{"x":100,"y":60,"z":1},{"x":-100,"y":50,"z":3.5},{"x":-90,"y":50,"z":3},{"x":-80,"y":50,"z":-3},{"x":-70,"y":50,"z":-3},{"x":-60,"y":50,"z":-4},{"x":-50,"y":50,"z":-7},{"x":-40,"y":50,"z":-5},{"x":-30,"y":50,"z":-1.5},{"x":-20,"y":50,"z":0},{"x":-10,"y":50,"z":-1.5},{"x":0,"y":50,"z":-1.5},{"x":10,"y":50,"z":-1},{"x":20,"y":50,"z":-4.5},{"x":30,"y":50,"z":0},{"x":40,"y":50,"z":1.5},{"x":50,"y":50,"z":2},{"x":60,"y":50,"z":2},{"x":70,"y":50,"z":2},{"x":80,"y":50,"z":2},{"x":90,"y":50,"z":5.5},{"x":100,"y":50,"z":1},{"x":-100,"y":40,"z":3.5},{"x":-90,"y":40,"z":2},{"x":-80,"y":40,"z":-3.5},{"x":-70,"y":40,"z":-2},{"x":-60,"y":40,"z":-2},{"x":-50,"y":40,"z":-9},{"x":-40,"y":40,"z":-12.5},{"x":-30,"y":40,"z":-6.5},{"x":-20,"y":40,"z":-1},{"x":-10,"y":40,"z":0},{"x":0,"y":40,"z":0},{"x":10,"y":40,"z":-0.5},{"x":20,"y":40,"z":-4},{"x":30,"y":40,"z":-1},{"x":40,"y":40,"z":1},{"x":50,"y":40,"z":2},{"x":60,"y":40,"z":2},{"x":70,"y":40,"z":2},{"x":80,"y":40,"z":2},{"x":90,"y":40,"z":6},{"x":100,"y":40,"z":0.5},{"x":-100,"y":30,"z":2},{"x":-90,"y":30,"z":0},{"x":-80,"y":30,"z":-3},{"x":-70,"y":30,"z":-2},{"x":-60,"y":30,"z":-0.5},{"x":-50,"y":30,"z":-4.5},{"x":-40,"y":30,"z":-11},{"x":-30,"y":30,"z":-10},{"x":-20,"y":30,"z":-4},{"x":-10,"y":30,"z":-0.5},{"x":0,"y":30,"z":1.5},{"x":10,"y":30,"z":1},{"x":20,"y":30,"z":-2},{"x":30,"y":30,"z":-5.5},{"x":40,"y":30,"z":-6},{"x":50,"y":30,"z":-3.5},{"x":60,"y":30,"z":-2.5},{"x":70,"y":30,"z":-3.5},{"x":80,"y":30,"z":3.5},{"x":90,"y":30,"z":6},{"x":100,"y":30,"z":0},{"x":-100,"y":20,"z":3},{"x":-90,"y":20,"z":-2},{"x":-80,"y":20,"z":-4},{"x":-70,"y":20,"z":-1.5},{"x":-60,"y":20,"z":-1},{"x":-50,"y":20,"z":-1},{"x":-40,"y":20,"z":-3},{"x":-30,"y":20,"z":-9},{"x":-20,"y":20,"z":-8.5},{"x":-10,"y":20,"z":-1.5},{"x":0,"y":20,"z":0},{"x":10,"y":20,"z":-1.5},{"x":20,"y":20,"z":-2},{"x":30,"y":20,"z":-1},{"x":40,"y":20,"z":-2.5},{"x":50,"y":20,"z":-3.5},{"x":60,"y":20,"z":-3},{"x":70,"y":20,"z":-5},{"x":80,"y":20,"z":1},{"x":90,"y":20,"z":4.5},{"x":100,"y":20,"z":0},{"x":-100,"y":10,"z":3},{"x":-90,"y":10,"z":-2.5},{"x":-80,"y":10,"z":-5},{"x":-70,"y":10,"z":-3},{"x":-60,"y":10,"z":-2},{"x":-50,"y":10,"z":-0.5},{"x":-40,"y":10,"z":-1},{"x":-30,"y":10,"z":-5.5},{"x":-20,"y":10,"z":-6},{"x":-10,"y":10,"z":-1},{"x":0,"y":10,"z":-1.5},{"x":10,"y":10,"z":-2.5},{"x":20,"y":10,"z":-1},{"x":30,"y":10,"z":1},{"x":40,"y":10,"z":1},{"x":50,"y":10,"z":0},{"x":60,"y":10,"z":-0.5},{"x":70,"y":10,"z":-3.5},{"x":80,"y":10,"z":0.5},{"x":90,"y":10,"z":4},{"x":100,"y":10,"z":0.5},{"x":-100,"y":0,"z":2.5},{"x":-90,"y":0,"z":-1.5},{"x":-80,"y":0,"z":-5},{"x":-70,"y":0,"z":-3.5},{"x":-60,"y":0,"z":-3},{"x":-50,"y":0,"z":-3.5},{"x":-40,"y":0,"z":-2.5},{"x":-30,"y":0,"z":-1},{"x":-20,"y":0,"z":-1},{"x":-10,"y":0,"z":-1},{"x":0,"y":0,"z":-0.5},{"x":10,"y":0,"z":0},{"x":20,"y":0,"z":0},{"x":30,"y":0,"z":0.5},{"x":40,"y":0,"z":0.5},{"x":50,"y":0,"z":1},{"x":60,"y":0,"z":1},{"x":70,"y":0,"z":-3.5},{"x":80,"y":0,"z":0.5},{"x":90,"y":0,"z":4.5},{"x":100,"y":0,"z":0.5},{"x":-100,"y":-10,"z":2},{"x":-90,"y":-10,"z":-2},{"x":-80,"y":-10,"z":-6.5},{"x":-70,"y":-10,"z":-2.5},{"x":-60,"y":-10,"z":-1},{"x":-50,"y":-10,"z":-3.5},{"x":-40,"y":-10,"z":-2.5},{"x":-30,"y":-10,"z":-2},{"x":-20,"y":-10,"z":-2.5},{"x":-10,"y":-10,"z":-1.5},{"x":0,"y":-10,"z":-2.5},{"x":10,"y":-10,"z":-4.5},{"x":20,"y":-10,"z":-2.5},{"x":30,"y":-10,"z":-1},{"x":40,"y":-10,"z":-1.5},{"x":50,"y":-10,"z":-0.5},{"x":60,"y":-10,"z":0},{"x":70,"y":-10,"z":-3.5},{"x":80,"y":-10,"z":0},{"x":90,"y":-10,"z":4},{"x":100,"y":-10,"z":0.5},{"x":-100,"y":-20,"z":1.5},{"x":-90,"y":-20,"z":-1},{"x":-80,"y":-20,"z":-6},{"x":-70,"y":-20,"z":-8},{"x":-60,"y":-20,"z":-5},{"x":-50,"y":-20,"z":-1},{"x":-40,"y":-20,"z":-1},{"x":-30,"y":-20,"z":-3},{"x":-20,"y":-20,"z":-2.5},{"x":-10,"y":-20,"z":-0.5},{"x":0,"y":-20,"z":-2.5},{"x":10,"y":-20,"z":-9},{"x":20,"y":-20,"z":-10},{"x":30,"y":-20,"z":-5.5},{"x":40,"y":-20,"z":-3.5},{"x":50,"y":-20,"z":-3},{"x":60,"y":-20,"z":-3.5},{"x":70,"y":-20,"z":-4.5},{"x":80,"y":-20,"z":2},{"x":90,"y":-20,"z":5},{"x":100,"y":-20,"z":0.5},{"x":-100,"y":-30,"z":2},{"x":-90,"y":-30,"z":2},{"x":-80,"y":-30,"z":1.5},{"x":-70,"y":-30,"z":-1.5},{"x":-60,"y":-30,"z":-1.5},{"x":-50,"y":-30,"z":-4},{"x":-40,"y":-30,"z":-3.5},{"x":-30,"y":-30,"z":-2.5},{"x":-20,"y":-30,"z":-2},{"x":-10,"y":-30,"z":-3},{"x":0,"y":-30,"z":-2.5},{"x":10,"y":-30,"z":-5},{"x":20,"y":-30,"z":-9},{"x":30,"y":-30,"z":-10.5},{"x":40,"y":-30,"z":-7},{"x":50,"y":-30,"z":-2},{"x":60,"y":-30,"z":-3},{"x":70,"y":-30,"z":-5.5},{"x":80,"y":-30,"z":3.5},{"x":90,"y":-30,"z":6.5},{"x":100,"y":-30,"z":0},{"x":-100,"y":-40,"z":2.5},{"x":-90,"y":-40,"z":2},{"x":-80,"y":-40,"z":2},{"x":-70,"y":-40,"z":2},{"x":-60,"y":-40,"z":2},{"x":-50,"y":-40,"z":1},{"x":-40,"y":-40,"z":0},{"x":-30,"y":-40,"z":-3},{"x":-20,"y":-40,"z":-2},{"x":-10,"y":-40,"z":-4},{"x":0,"y":-40,"z":-3},{"x":10,"y":-40,"z":-2},{"x":20,"y":-40,"z":-4.5},{"x":30,"y":-40,"z":-8.5},{"x":40,"y":-40,"z":-9},{"x":50,"y":-40,"z":-3.5},{"x":60,"y":-40,"z":-1},{"x":70,"y":-40,"z":-3.5},{"x":80,"y":-40,"z":2},{"x":90,"y":-40,"z":4.5},{"x":100,"y":-40,"z":0},{"x":-100,"y":-50,"z":3},{"x":-90,"y":-50,"z":2},{"x":-80,"y":-50,"z":2},{"x":-70,"y":-50,"z":2},{"x":-60,"y":-50,"z":2},{"x":-50,"y":-50,"z":1.5},{"x":-40,"y":-50,"z":1},{"x":-30,"y":-50,"z":-3},{"x":-20,"y":-50,"z":-2},{"x":-10,"y":-50,"z":-3.5},{"x":0,"y":-50,"z":-2.5},{"x":10,"y":-50,"z":-3},{"x":20,"y":-50,"z":-3.5},{"x":30,"y":-50,"z":-3.5},{"x":40,"y":-50,"z":-6},{"x":50,"y":-50,"z":-4.5},{"x":60,"y":-50,"z":-3},{"x":70,"y":-50,"z":-3},{"x":80,"y":-50,"z":2.5},{"x":90,"y":-50,"z":3},{"x":100,"y":-50,"z":0},{"x":-100,"y":-60,"z":2},{"x":-90,"y":-60,"z":2},{"x":-80,"y":-60,"z":2},{"x":-70,"y":-60,"z":2},{"x":-60,"y":-60,"z":2},{"x":-50,"y":-60,"z":2},{"x":-40,"y":-60,"z":2},{"x":-30,"y":-60,"z":-2},{"x":-20,"y":-60,"z":-2},{"x":-10,"y":-60,"z":-3},{"x":0,"y":-60,"z":-2.5},{"x":10,"y":-60,"z":-2.5},{"x":20,"y":-60,"z":-0.5},{"x":30,"y":-60,"z":-0.5},{"x":40,"y":-60,"z":-2.5},{"x":50,"y":-60,"z":-5.5},{"x":60,"y":-60,"z":-5.5},{"x":70,"y":-60,"z":-1.5},{"x":80,"y":-60,"z":3.5},{"x":90,"y":-60,"z":4.5},{"x":100,"y":-60,"z":1.5},{"x":-100,"y":-70,"z":2},{"x":-90,"y":-70,"z":2},{"x":-80,"y":-70,"z":2},{"x":-70,"y":-70,"z":2},{"x":-60,"y":-70,"z":2},{"x":-50,"y":-70,"z":2},{"x":-40,"y":-70,"z":1.5},{"x":-30,"y":-70,"z":-3.5},{"x":-20,"y":-70,"z":-2.5},{"x":-10,"y":-70,"z":-1.5},{"x":0,"y":-70,"z":-2},{"x":10,"y":-70,"z":-3},{"x":20,"y":-70,"z":-1.5},{"x":30,"y":-70,"z":-2},{"x":40,"y":-70,"z":-4},{"x":50,"y":-70,"z":-6},{"x":60,"y":-70,"z":-3.5},{"x":70,"y":-70,"z":0},{"x":80,"y":-70,"z":3.5},{"x":90,"y":-70,"z":7},{"x":100,"y":-70,"z":3.5},{"x":-100,"y":-80,"z":2},{"x":-90,"y":-80,"z":2},{"x":-80,"y":-80,"z":2},{"x":-70,"y":-80,"z":2},{"x":-60,"y":-80,"z":2},{"x":-50,"y":-80,"z":2},{"x":-40,"y":-80,"z":1.5},{"x":-30,"y":-80,"z":-4},{"x":-20,"y":-80,"z":-4},{"x":-10,"y":-80,"z":-3},{"x":0,"y":-80,"z":-2},{"x":10,"y":-80,"z":-2.5},{"x":20,"y":-80,"z":-2.5},{"x":30,"y":-80,"z":-3.5},{"x":40,"y":-80,"z":-4},{"x":50,"y":-80,"z":-2},{"x":60,"y":-80,"z":2},{"x":70,"y":-80,"z":3},{"x":80,"y":-80,"z":4.5},{"x":90,"y":-80,"z":8},{"x":100,"y":-80,"z":4},{"x":-100,"y":-90,"z":2},{"x":-90,"y":-90,"z":2},{"x":-80,"y":-90,"z":2},{"x":-70,"y":-90,"z":2},{"x":-60,"y":-90,"z":2},{"x":-50,"y":-90,"z":2},{"x":-40,"y":-90,"z":2},{"x":-30,"y":-90,"z":1},{"x":-20,"y":-90,"z":2.5},{"x":-10,"y":-90,"z":3},{"x":0,"y":-90,"z":2.5},{"x":10,"y":-90,"z":2},{"x":20,"y":-90,"z":2},{"x":30,"y":-90,"z":1},{"x":40,"y":-90,"z":2},{"x":50,"y":-90,"z":4},{"x":60,"y":-90,"z":5.5},{"x":70,"y":-90,"z":7},{"x":80,"y":-90,"z":7.5},{"x":90,"y":-90,"z":10},{"x":100,"y":-90,"z":6},{"x":-100,"y":-100,"z":0.5},{"x":-90,"y":-100,"z":0},{"x":-80,"y":-100,"z":2},{"x":-70,"y":-100,"z":2},{"x":-60,"y":-100,"z":5},{"x":-50,"y":-100,"z":3},{"x":-40,"y":-100,"z":1},{"x":-30,"y":-100,"z":3},{"x":-20,"y":-100,"z":6},{"x":-10,"y":-100,"z":5.5},{"x":0,"y":-100,"z":4.5},{"x":10,"y":-100,"z":4},{"x":20,"y":-100,"z":3.5},{"x":30,"y":-100,"z":2.5},{"x":40,"y":-100,"z":3},{"x":50,"y":-100,"z":4.5},{"x":60,"y":-100,"z":4},{"x":70,"y":-100,"z":4},{"x":80,"y":-100,"z":5.5},{"x":90,"y":-100,"z":7},{"x":100,"y":-100,"z":4}] ;

        var forest = [{"x":50,"y":-40},{"x":53,"y":-45},{"x":58,"y":-50},{"x":59,"y":-41},{"x":59,"y":-43},{"x":60,"y":-35},{"x":45,"y":-17},{"x":51,"y":-19},{"x":52,"y":-24},{"x":63,"y":-22},{"x":62,"y":-16},{"x":60,"y":-11},{"x":56,"y":-8},{"x":37,"y":-20},{"x":35,"y":-16},{"x":35,"y":-5},{"x":42,"y":-4},{"x":47,"y":-6},{"x":61,"y":5},{"x":62,"y":13},{"x":60,"y":17},{"x":58,"y":18},{"x":49,"y":9},{"x":48,"y":15},{"x":46,"y":18},{"x":39,"y":25},{"x":42,"y":21},{"x":32,"y":21},{"x":36,"y":22},{"x":28,"y":12},{"x":20,"y":5},{"x":24,"y":1},{"x":30,"y":0},{"x":24,"y":10},{"x":37,"y":7},{"x":37,"y":6},{"x":44,"y":-67},{"x":43,"y":-59},{"x":27,"y":-69},{"x":29,"y":-72},{"x":32,"y":-71},{"x":66,"y":-77},{"x":69,"y":-81},{"x":72,"y":-67},{"x":15,"y":-55},{"x":21,"y":-56},{"x":26,"y":-58},{"x":36,"y":-46},{"x":34,"y":-48},{"x":26,"y":-48},{"x":19,"y":-43},{"x":20,"y":-37},{"x":22,"y":-31},{"x":12,"y":-70},{"x":18,"y":-70},{"x":3,"y":-71},{"x":-9,"y":-69},{"x":-2,"y":-69},{"x":-5,"y":-65},{"x":5,"y":-57},{"x":6,"y":-59},{"x":11,"y":-44},{"x":10,"y":-37},{"x":2,"y":-35},{"x":-1,"y":-38},{"x":3,"y":-26},{"x":1,"y":-21},{"x":-7,"y":-18},{"x":-11,"y":-23},{"x":-12,"y":-25},{"x":-10,"y":-35},{"x":-12,"y":-40},{"x":-11,"y":-44},{"x":-8,"y":-48},{"x":-5,"y":-50},{"x":-20,"y":-69},{"x":-19,"y":-62},{"x":-19,"y":-59},{"x":-15,"y":-57},{"x":-18,"y":-51},{"x":-23,"y":-43},{"x":-25,"y":-37},{"x":-22,"y":-33},{"x":-35,"y":-20},{"x":-41,"y":-23},{"x":-47,"y":-20},{"x":-50,"y":-17},{"x":-52,"y":-10},{"x":-52,"y":-1},{"x":-38,"y":-11},{"x":-34,"y":-8},{"x":-35,"y":-2},{"x":-41,"y":-4},{"x":-30,"y":-5},{"x":-22,"y":-4},{"x":-24,"y":1},{"x":-27,"y":3},{"x":-25,"y":-10},{"x":-2,"y":29},{"x":1,"y":24},{"x":5,"y":21},{"x":11,"y":25},{"x":12,"y":31},{"x":9,"y":39},{"x":11,"y":44},{"x":9,"y":50},{"x":6,"y":56},{"x":17,"y":38},{"x":21,"y":40},{"x":23,"y":43},{"x":19,"y":55},{"x":21,"y":59},{"x":18,"y":64},{"x":19,"y":68},{"x":19,"y":75},{"x":7,"y":69},{"x":7,"y":71},{"x":5,"y":73},{"x":-1,"y":74},{"x":-15,"y":72},{"x":-19,"y":71},{"x":-32,"y":70},{"x":-29,"y":71},{"x":-34,"y":73},{"x":-46,"y":69},{"x":-63,"y":40},{"x":-63,"y":44},{"x":-63,"y":52},{"x":-63,"y":54},{"x":-55,"y":56},{"x":-62,"y":51},{"x":-53,"y":18},{"x":-55,"y":23},{"x":-41,"y":17},{"x":-38,"y":11},{"x":-39,"y":7},{"x":-43,"y":4},{"x":-49,"y":6},{"x":-51,"y":8},{"x":1,"y":40},{"x":-4,"y":40},{"x":-12,"y":39},{"x":-14,"y":40},{"x":-14,"y":43},{"x":-13,"y":47},{"x":-10,"y":52},{"x":-17,"y":56},{"x":-20,"y":58},{"x":-24,"y":62},{"x":-33,"y":61},{"x":-47,"y":66},{"x":-46,"y":63},{"x":-9,"y":65},{"x":-7,"y":61},{"x":24,"y":16},{"x":39,"y":32},{"x":-67,"y":26},{"x":-67,"y":18}, {"x":84,"y":43},{"x":83,"y":14},{"x":83,"y":-13},{"x":82,"y":-50},{"x":84,"y":-40},{"x":82,"y":-74},{"x":69,"y":-77},{"x":76,"y":-67},{"x":80,"y":-83},{"x":53,"y":-87},{"x":49,"y":-83},{"x":17,"y":-88},{"x":-15,"y":-88},{"x":-3,"y":-89},{"x":21,"y":-89},{"x":40,"y":24},{"x":-2,"y":92},{"x":-23,"y":93},{"x":-62,"y":89},{"x":-78,"y":83},{"x":-80,"y":89},{"x":-86,"y":75},{"x":-77,"y":80},{"x":-89,"y":58},{"x":-89,"y":46},{"x":-89,"y":29},{"x":-89,"y":0},{"x":-89,"y":-25},{"x":-91,"y":5},{"x":-89,"y":-52},{"x":-90,"y":-18},{"x":-91,"y":77},{"x":-68,"y":-10},{"x":-66,"y":-4},{"x":-62,"y":-15},{"x":-63,"y":-3},{"x":66,"y":-82}]

        var neutralLights = [{"x":49.95580760154377,"y":-57.22164219000579,"z":5},{"x":61.12127140319896,"y":-45.5714022841147,"z":5},{"x":36.362193350429976,"y":-43.955501857548214,"z":5},{"x":31.16168096711729,"y":-29.998808346007095,"z":5},{"x":24.633818751146066,"y":-3.8487931847963637,"z":5},{"x":-2.0404479088254845,"y":-8.551997813019852,"z":5},{"x":-11.729911101883204,"y":6.504144533139652,"z":5},{"x":0.7259387061986047,"y":14.838299219906816,"z":5},{"x":12.779839781024549,"y":3.2967225527459902,"z":5},{"x":-29.078674858200685,"y":13.781937261639172,"z":5},{"x":-8.536909763628955,"y":30.062264133734942,"z":5},{"x":-42.6523924555558,"y":26.643925845457602,"z":5},{"x":-39.18800723479575,"y":52.8364018747414,"z":5},{"x":-48.96146539599215,"y":34.683952684950896,"z":5},{"x":57.96197500446183,"y":67.75562024384533,"z":5},{"x":60.16906382823661,"y":66.44676884234161,"z":5},{"x":62.458651876182394,"y":65.54032898548027,"z":5},{"x":-62.12608461296816,"y":-55.51512292609971,"z":5},{"x":-60.27219795387463,"y":-57.16058919402303,"z":5},{"x":-62.809280635697384,"y":-54.38336884586829,"z":5}]

        var redTowerInit =
        [
        { x:17, y:17},
        { x:28, y:38},
        { x:38, y:80},
        { x:5, y:80},
        { x:42, y:50},
        { x:72, y:45},
        { x:-40, y:80},
        { x:70, y:10},
        { x:75, y:-37},
        { x:-40, y:80},
        {"x":67,"y":66},
        {"x":62,"y":72}
        ];
        var blueTowerInit =
        [

        { x:-17, y:-10},
        { x:-28, y:-30},
        { x:-38, y:-80},
        { x:-5, y:-80},
        { x:-42, y:-50},
        { x:-72, y:-45},
        { x:40, y:-80},
        { x:-70, y:-10},
        { x:-75, y:37},
        { x:40, y:-80},
        { "x":-55, "y":-69},
        { "x":-61, "y":-62}
        ];


        var textures = {
            'blueTower' : 'img/bluetower.png',
            'redTower' : 'img/redtower.png',
            'redInhib' : 'img/redInhib.png',
            'blueInhib' : 'img/blueInhib.png',
            'redNexus' : 'img/redNexus.png',
            'blueNexus' : 'img/blueNexus.png',
            'tree' : 'img/arbre.png',
            'flagRed' : 'img/fnatic-flag.png',
            'topRed' : 'img/topflagRed.png',
            'flagBlue' : 'img/c9-flag.png',
            'topBlue' : 'img/topflagBlue.png',
            'logo1' : 'img/logo1.png',
            'logo2' : 'img/logo2.png',
            'plank' : 'img/wood.png',
            'groundTexture' : 'img/centred.png',
        }




        // on initialise le moteur de rendu
        renderer = new THREE.WebGLRenderer( { alpha: true,  antialias: true  });
        renderer.setClearColor( 0x000000, 0 )
        theta = 0
        // si WebGL ne fonctionne pas sur votre navigateur vous pouvez utiliser le moteur de rendu Canvas à la place
        // renderer = new THREE.CanvasRenderer();
        // renderer.setClearColor( 0xffffff, 1);
        renderer.setSize( window.innerWidth, window.innerHeight );
        document.getElementById('container').appendChild(renderer.domElement);

        // on initialise la scène
        scene = new THREE.Scene();
        projector = new THREE.Projector();
        // on initialise la camera que l’on place ensuite sur la scène
        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 10000 );
        camera.position.set(0, 0, radius);

        scene.add(camera);


        var minimap = new Minimap(arrayMap, textures, {'blueTowers' : blueTowerInit, 'redTowers' : redTowerInit}, forest, neutralLights )
        minimap.create()
        scene.add(minimap.parent)
        map = minimap




// /////////////////////////////////////////// neutrals 
        spriteList.push(new SpriteAnimated(28, -35, -1, 10, 15, 'img/drake.png', 0x66ff00))
        spriteList.push(new SpriteAnimated(-29, 42, 2,8, 15, 'img/nashor.png', 0xff00ff))

////////////////////////////////////////// test hero
        champ1 = new SpriteHero(-60, -60, 5, 7, 7, 'img/jayce.png', 0x66ff00, [])
        scene.add(champ1.mesh)

////////////////////////////////////////// Adding the sprites to the scene
        for (var i = 0; i < spriteList.length; ++i) { 
            scene.add(spriteList[i].mesh)
            scene.add(spriteList[i].light)
        }






///////////////////////////////////////// Spark particles
        particles = new THREE.Geometry()
        var pMaterial = new THREE.ParticleBasicMaterial({
            color: 0xFFFFFF,
            size: 2,
            map: THREE.ImageUtils.loadTexture(
             "img/spark.png"
            ),
            blending: THREE.AdditiveBlending,
            transparent: true
        });

        for (var p = 0; p < particleCount; p++) {
            // position values, -250 -> 250
            // var pX = Math.random() * 200 - 100,
            //     pY = Math.random() * 200 - 100,
            //     pZ = 0
            var pX = Math.random() * 500 - 250,
                pY = Math.random() * 500 - 250,
                pZ = Math.random() * 500 - 250
            var particle = new THREE.Vector3(pX, pY, pZ);
                particle.velocity = new THREE.Vector3(pX/2, pY/2, pZ/2);

            particles.vertices.push(particle);
        }
        particleSystem = new THREE.ParticleSystem(particles, pMaterial);
        particleSystem.sortParticles = true;
        scene.add(particleSystem);


/////////////////////////////////////////// Lights

        var ambientLight = new THREE.AmbientLight(0xFFFFFF);
        scene.add(ambientLight);

        var areaLight1 = new THREE.AreaLight( 0x00ff00, 10);
        areaLight1.position.set( 0.0001, 10.0001, 10.5001 );
        areaLight1.width = 10;
        areaLight1.height = 2;
        scene.add( areaLight1 );

        // renderer.setClearColor( 0xffffff, 1);

        document.addEventListener( 'mousedown', onDocumentMouseDown, false );
        document.addEventListener( 'mouseup', onDocumentMouseUp, false);
        document.addEventListener( 'mousemove', onDocumentMouseMove, false);

        var mousewheelevt=(/Firefox/i.test(navigator.userAgent))? "DOMMouseScroll" : "mousewheel" //FF doesn't recognize mousewheel as of FF3.x
		if (document.attachEvent) //if IE (and Opera depending on user setting)
		    document.attachEvent("on"+mousewheelevt, onDocumentMouseWheel)
		else if (document.addEventListener) //WC3 browsers
		    document.addEventListener(mousewheelevt, onDocumentMouseWheel, false)
        document.addEventListener( 'keydown', onKeyDocumentPress, false );



    }


    function animate(){
        var elapsedTime = frameClock.getDelta();
        
        // on appel la fonction animate() récursivement à chaque frame
        requestAnimationFrame( animate );

        //theta += elapsedTime * 5;

        for (var i = 0; i < spriteList.length; ++i) { 
        // console.log(spriteList[i])
            spriteList[i].update(theta * Math.PI/180);
        }

        // var pCount = particleCount;
        // while (pCount--) {

        //     // get the particle
        //     var particle = particles.vertices[pCount];
        //     // check if we need to reset
        //     if (particle.z > 20) {
        //         particle.z -= 0.2;
        //         particle.velocity.z = 0;
        //     } 
        //    if (particle.z < 0) {
        //         particle.z = 0;
        //     }

        //     // update the velocity with
        //     // a splat of randomniz
        //     particle.velocity.z += Math.random() * 0.2 - 0.1;

        //     // and the position
        //     particle.z += particle.velocity.z

        //     // flag to the particle system
        //     // that we've changed its vertices.

        // }


        // particleSystem.geometry.needsUpdate = true;
        if (champ1.mesh.position.x > 80 && champ1.mesh.position.y > 80) offset = {x: -0.5,y: -0.5, z: 0}
        if (champ1.mesh.position.x < -80 && champ1.mesh.position.y < -80) offset = {x: 0.5,y: 0.5, z: 0}

        champ1.move(offset)

        var time = Date.now();


        map.simulate(time, elapsedTime);
        /*camera.position.x = 300 * Math.cos( theta *Math.PI/180);
        camera.position.y = 300 * Math.sin( theta *Math.PI/180);
        camera.position.z = 200;*/

	    camera.position.x = radius * Math.sin(theta*Math.PI/180) * Math.cos(phi*Math.PI/180) + lookAtVector.x;
	    camera.position.y = radius * Math.sin(theta*Math.PI/180) * Math.sin(phi*Math.PI/180) + lookAtVector.y;
	    camera.position.z = radius * Math.cos(theta*Math.PI/180) + lookAtVector.z;

 
        // meshTour.rotation.y = theta
        camera.up = new THREE.Vector3(0,0,1);
        camera.lookAt(lookAtVector);
        // on effectue le rendu de la scène
        renderer.render( scene, camera );
    }



    function onKeyDocumentPress(event) {
        event.preventDefault();   
        map.create()
        map.ready = false;
        map.mapReady = false;
    }

    function onDocumentMouseMove( event ) {
    	event.preventDefault();
    	if(mouseDown){
    		var offset = {
    			x: event.clientX - lastMousePosition.x,
    			y: event.clientY - lastMousePosition.y
    		}
    		lastMousePosition.x = event.clientX;
    		lastMousePosition.y = event.clientY;

        	phi += 120 * (-offset.x/1920);
    		theta += 120 * (offset.y/1080);
    	}
        else if(rightMouseDown){
            var offset = {
                x: event.clientX - lastMousePosition.x,
                y: event.clientY - lastMousePosition.y
            }

            lookAtVector.x += offset.x/2.0;
            lookAtVector.y += offset.y/2.0;
            lastMousePosition.x = event.clientX;
            lastMousePosition.y = event.clientY;
        }
    }

    function onDocumentMouseWheel( event ) {
		var evt=window.event || event //equalize event object
	    var delta=evt.detail? evt.detail*(120) : evt.wheelDelta //check for detail first so Opera uses that instead of wheelDelta
	    radius -= delta/30;
	    console.log();
    }

    function fixWhich(e) {
        if (!e.which && e.button) {
            if (e.button & 1) e.which = 1      // Left
            else if (e.button & 4) e.which = 2 // Middle
            else if (e.button & 2) e.which = 3 // Right
        }
    }


    function onDocumentMouseDown( event ) {
        event.preventDefault();
        fixWhich(event);
        if(event.which == 3){
            rightMouseDown = true;
        }
        if(event.which == 1){
            mouseDown = true;
        } 
        lastMousePosition.x = event.clientX;
        lastMousePosition.y = event.clientY;

        var vector = new THREE.Vector3( ( event.clientX / window.innerWidth ) * 2 - 1, - ( event.clientY / window.innerHeight ) * 2 + 1, 0.5 );
        projector.unprojectVector( vector, camera );

        var raycaster = new THREE.Raycaster( camera.position, vector.sub( camera.position ).normalize() );

        var intersects = raycaster.intersectObjects( objects );

        if ( intersects.length > 0 ) {
        // spriteList.push(new Sprite(intersects[0].point.x-7, intersects[0].point.y-3, 5, 6, 10, 'img/redtower.png'))
        // foretList.push({x:parseInt(intersects[0].point.x.toFixed() - 7), y:parseInt(intersects[0].point.y.toFixed() -3)})
        // scene.add(spriteList[spriteList.length-1].mesh)
        // console.log( JSON.stringify(foretList));
            console.log('x: ' + intersects[0].point.x)
            console.log('y: ' + intersects[0].point.y)
        // for (var i = 0, l = map.vertices.length; i < l; i++) {
        //   if (map.vertices[i].x + 5 < intersects[0].point.x +10 && map.vertices[i].x + 5> intersects[0].point.x -10 &&
        //     map.vertices[i].y+ 2 < intersects[0].point.y +10 && map.vertices[i].y+ 2 > intersects[0].point.y -10) {
        //     map.vertices[i].z -=0.5;
        //     map.verticesNeedUpdate = true;
        //   }
        // }

        // var light = new THREE.PointLight( 0x0088FF, 3, 20 );
        // light.position.set(  intersects[0].point.x,  intersects[0].point.y, 5 );
        // lightList.push(light.position);
        // console.log( JSON.stringify(lightList));

        // scene.add( light );
        // for (var i = 0, l = materials.length; i < l; i++) {
        //     materials[i].needsUpdate = true;
        // }

        }

        /*
        // Parse all the faces
        for ( var i in intersects ) {

        intersects[ i ].face.material[ 0 ].color.setHex( Math.random() * 0xffffff | 0x80000000 );

        }
        */
    }

    function onDocumentMouseUp(event){
        fixWhich(event);
        if(event.which == 3){
            rightMouseDown = false;
        }
        else if(event.which == 1){
            mouseDown = false;
        }
    }

   
    function getHeight(x, y) {
            for (var i = 0, l = map.map.vertices.length; i < l; i++) {
                if (map.map.vertices[i].x + 5 < x +8 &&map.map.vertices[i].x + 5> x -8 &&
                   map.map.vertices[i].y+ 2 < y +8 &&map.map.vertices[i].y+ 2 > y -8) {
                    return map.map.vertices[i].z + 5;
            }
        }
        return 5;
    }


  // sprite prototype


    </script>
</body>
</html>